/* tout l'intérim en France*/ 

CREATE OR REPLACE VIEW fr_discovery.landing.LOCALISATION_CONCURRENTS_MARTIN AS  

( 

SELECT DISTINCT A.SIREN,A.SIRET,A.CODE_DEPARTEMENT,A.LIBELLE_DEPARTEMENT,A.LIBELLE_REGION,A.CODE_REGION,"x_longitude","y_latitude","DENOMINATION" 

from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE A 

left join (select "siret","x_longitude","y_latitude"  

from  FR_DISCOVERY.LANDING_EXT.WSI_SIRET_GEO_INSEE ) B 

on A.SIRET = B."siret" 

left join ( select "SIREN","DENOMINATION"  

from FR_DISCOVERY.LANDING_EXT.SIREN_UNITE_LEGALE_INSEE) as C 

on A.SIREN = C.SIREN 

WHERE A.ACTIVITE_PRINCIPALE='78.20Z' AND A.ETAT_ADMINISTRATIF = 'A' AND A.CODE_REGION IN ('84','75','76','44','28','32','52','93','27','53','24','11') AND A.CATEGORIE_JURIDIQUE != '1000' order by C.DENOMINATION 

); 

  

SELECT * FROM FR_DISCOVERY.CONSUMER_KUSR.VW_MDM_ORGANISATION_APLATIE  

WHERE STATUT_ACT = 'O' AND VERSION_HISTO = 'J-1' AND TYPE_ENT = 'MOS' ; 

  

USE DATABASE FR_DISCOVERY; 

  

  

/* tout les mos de France*/ 

CREATE OR REPLACE VIEW fr_discovery.landing.LOCALISATION_MOS_MARTIN AS  

( 

SELECT DISTINCT A.LB_SPE_ENT, A.CODE_AGE, A.LIB_LONG, A.TYPE_ENT, NO_SIRET, "x_longitude", "y_latitude", LIBELLE_DEPARTEMENT, LIBELLE_REGION,SI_AA,MM 

FROM FR_DISCOVERY.CONSUMER_KUSR.VW_MDM_ORGANISATION_APLATIE A 

LEFT JOIN ( 

    SELECT ENT, NO_SIRET,SI_AA,MM, ROW_NUMBER() OVER (PARTITION BY ENT ORDER BY SI_AA DESC, MM DESC) AS rn 

    FROM FR_DISCOVERY.LANDING.DB2_AGGSAH 

) B ON A.CODE_AGE = B.ENT 

LEFT JOIN ( 

    SELECT "siret", "x_longitude", "y_latitude" 

    FROM FR_DISCOVERY.LANDING_EXT.WSI_SIRET_GEO_INSEE 

) C ON CAST(B.NO_SIRET AS VARCHAR) = CAST(C."siret" AS VARCHAR) 

LEFT JOIN ( 

    SELECT SIRET, LIBELLE_DEPARTEMENT, LIBELLE_REGION 

    FROM FR_DISCOVERY.LANDING_EXT.SIRET_INSEE 

) D ON D.SIRET = B.NO_SIRET 

WHERE B.rn = 1 AND A.STATUT_ACT = 'O' AND A.VERSION_HISTO = 'J-1' AND A.TYPE_ENT ='MOS' 

); 

  

/* tout les manpower de France*/ 

CREATE OR REPLACE VIEW fr_discovery.landing.LOCALISATION_AGENCES_MANPOWER_MARTIN AS  

( 

SELECT DISTINCT A.LB_SPE_ENT, A.CODE_AGE, A.LIB_LONG, A.TYPE_ENT, NO_SIRET, "x_longitude", "y_latitude", LIBELLE_DEPARTEMENT, LIBELLE_REGION,SI_AA,MM 

FROM FR_DISCOVERY.CONSUMER_KUSR.VW_MDM_ORGANISATION_APLATIE A 

LEFT JOIN ( 

    SELECT ENT, NO_SIRET,SI_AA,MM, ROW_NUMBER() OVER (PARTITION BY ENT ORDER BY SI_AA DESC, MM DESC) AS rn 

    FROM FR_DISCOVERY.LANDING.DB2_AGGSAH 

) B ON A.CODE_AGE = B.ENT 

LEFT JOIN ( 

    SELECT "siret", "x_longitude", "y_latitude" 

    FROM FR_DISCOVERY.LANDING_EXT.WSI_SIRET_GEO_INSEE 

) C ON CAST(B.NO_SIRET AS VARCHAR) = CAST(C."siret" AS VARCHAR) 

LEFT JOIN ( 

    SELECT SIRET, LIBELLE_DEPARTEMENT, LIBELLE_REGION 

    FROM FR_DISCOVERY.LANDING_EXT.SIRET_INSEE 

) D ON D.SIRET = B.NO_SIRET 

WHERE B.rn = 1 AND A.STATUT_ACT = 'O' AND A.VERSION_HISTO = 'J-1' ORDER BY A.TYPE_ENT 

); 

  

/* MOS + samsic et adequat pour sur*/ 

CREATE OR REPLACE TABLE fr_discovery.landing.A_AGENCE_ONSITE_CONCU_PARTIEL_MARTIN AS  

( 

select A.DENOMINATION,A.SIRET,B.SIREN,C."x_longitude" as longitude,C."y_latitude" as latitude from fr_discovery.landing.A_AGENCE_ONSITE_CONCU_PARTIEL_MARTIN A 

    left join(select SIREN,SIRET from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE) B 

    on CAST(A.SIRET as VARCHAR) = CAST(B.SIRET as VARCHAR) 

    left join (select "x_longitude","y_latitude","siret" from FR_DISCOVERY.LANDING_EXT.WSI_SIRET_GEO_INSEE) C 

    on CAST(C."siret" as VARCHAR) = CAST(A.SIRET as VARCHAR) 

order by B.SIREN 

); 

  

  

/* certaines agences on site hors manpower*/ 

/*WITH*/  

/* addresse de tout les concurents*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_ADD_CONCU as ( 

    select CODE_POSTAL as CP,NUMERO_VOIE as NV,LIBELLE_VOIE as LV  

    from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE 

    where ACTIVITE_PRINCIPALE='78.20Z' AND ETAT_ADMINISTRATIF = 'A' AND CODE_REGION IN ('84','75','76','44','28','32','52','93','27','53','24','11') AND CATEGORIE_JURIDIQUE != '1000' 

); 

  

/* toute les adresses avec 2 siret en franc*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET as ( 

    select CODE_POSTAL as CP,NUMERO_VOIE as NV,LIBELLE_VOIE as LV,COUNT(SIRET) as NB_SIRET 

    from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE 

    group by CP,NV,LV 

    having COUNT(SIRET) = 2 

); 

  

/* adresses supposées de Onsite*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_SUPPOSITION_OS as ( 

select DISTINCT FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.CP as CODE_P,FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.NV as NUM_V,FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.LV as LIB_V,FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.NB_SIRET from FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET 

where (FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.CP,FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.NV,FR_DISCOVERY.LANDING.MARTIN_DOUBLE_SIRET.LV) in( 

    select FR_DISCOVERY.LANDING.MARTIN_ADD_CONCU.CP, FR_DISCOVERY.LANDING.MARTIN_ADD_CONCU.NV, FR_DISCOVERY.LANDING.MARTIN_ADD_CONCU.LV from FR_DISCOVERY.LANDING.MARTIN_ADD_CONCU) 

); 

/* adresses des Onsite supposes ainsi que les sirets et le nom des clients*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_BRUT as ( 

select ETAT_ADMINISTRATIF,SIRET,CODE_P,NUM_V,LIB_V,DENOMINATION, CASE 

        WHEN ACTIVITE_PRINCIPALE='78.20Z' THEN 'Fournisseur' 

        ELSE 'Client' 

    END as STATUT  

    from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE as A 

    join(select CODE_P,NUM_V,LIB_V from FR_DISCOVERY.LANDING.MARTIN_SUPPOSITION_OS) B 

        on A.CODE_POSTAL=B.CODE_P AND A.NUMERO_VOIE = B.NUM_V AND A.LIBELLE_VOIE=B.LIB_V 

    join(select DENOMINATION,SIREN from FR_DISCOVERY.LANDING_EXT.SIREN_UNITE_LEGALE_INSEE) C 

        on A.SIREN = C.SIREN 

    where C.DENOMINATION != 'MANPOWER FRANCE' AND C.DENOMINATION != 'MANPOWER FRANCE HOLDING' AND ETAT_ADMINISTRATIF = 'A' 

order by B.CODE_P,B.NUM_V,B.LIB_V 

); 

/* selection plus précise des adresses à 2 siret exactement après correction*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_CLEANING as ( 

select CODE_P,NUM_V,LIB_V,COUNT(SIRET) as NB_SIRET from FR_DISCOVERY.LANDING.MARTIN_BRUT 

group by CODE_P,NUM_V,LIB_V 

having count(SIRET)=2 

); 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_BRUT_2 as ( 

select SIRET,CODE_P,NUM_V,LIB_V,DENOMINATION, CASE 

        WHEN ACTIVITE_PRINCIPALE='78.20Z' THEN 'Fournisseur' 

        ELSE 'Client' 

    END as STATUT  

    from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE as A 

    join(select CODE_P,NUM_V,LIB_V from FR_DISCOVERY.LANDING.MARTIN_CLEANING) B 

        on A.CODE_POSTAL=B.CODE_P AND A.NUMERO_VOIE = B.NUM_V AND A.LIBELLE_VOIE=B.LIB_V 

    join(select DENOMINATION,SIREN from FR_DISCOVERY.LANDING_EXT.SIREN_UNITE_LEGALE_INSEE) C 

        on A.SIREN = C.SIREN 

    where C.DENOMINATION != 'MANPOWER FRANCE' AND C.DENOMINATION != 'MANPOWER FRANCE HOLDING' AND ETAT_ADMINISTRATIF = 'A' 

order by B.CODE_P,B.NUM_V,B.LIB_V 

); 

/* sequençage des agences*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_ONSITE as ( 

select SIRET as SIRET_ONSITE,CODE_P,NUM_V,LIB_V,DENOMINATION as DENOMINATION_ONSITE from FR_DISCOVERY.LANDING.MARTIN_BRUT_2 

where STATUT ='Fournisseur' 

); 

/* sequençage des clients*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_CLIENT as ( 

select SIRET as SIRET_CLIENT,CODE_P,NUM_V,LIB_V,DENOMINATION as DENOMINATION_CLIENT from FR_DISCOVERY.LANDING.MARTIN_BRUT_2 

where STATUT ='Client' 

); 

/* association de l'agence au client sous forme de tab*/ 

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.MARTIN_JOINTURE as( 

select A.SIRET_ONSITE,A.DENOMINATION_ONSITE,SIRET_CLIENT,DENOMINATION_CLIENT,A.CODE_P,A.NUM_V,A.LIB_V,"x_longitude" as LONGITUDE,"y_latitude" as LATITUDE,D.SIREN from FR_DISCOVERY.LANDING.MARTIN_ONSITE A 

    left join ( select SIRET_CLIENT,DENOMINATION_CLIENT,CODE_P,NUM_V,LIB_V from FR_DISCOVERY.LANDING.MARTIN_CLIENT ) B 

    on A.CODE_P=B.CODE_P AND A.NUM_V=B.NUM_V AND A.LIB_V=B.LIB_V 

    left join(select "siret","x_longitude","y_latitude" from FR_DISCOVERY.LANDING_EXT.WSI_SIRET_GEO_INSEE) C 

    on A.SIRET_ONSITE = C."siret" 

    left join(select SIRET,SIREN from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE) D 

    on A.SIRET_ONSITE = D.SIRET 

    where B.SIRET_CLIENT IS NOT NULL 

order by A.CODE_P,A.NUM_V,A.LIB_V 

); 

/*INSERT INTO FR_DISCOVERY.LANDING.A_AGENCE_ONSITE_CONCU_PARTIEL_MARTIN select DENOMINATION_ONSITE,SIRET_ONSITE,SIREN,LONGITUDE,LATITUDE from FR_DISCOVERY.LANDING.MARTIN_JOINTURE*/ 

  

CREATE OR REPLACE VIEW FR_DISCOVERY.LANDING.A_AGENCE_ONSITE_CONCU_PARTIEL_STEP_3_MARTIN as( 

  select DENOMINATION,A.SIRET,A.SIREN,A.LONGITUDE,A.LATITUDE,LIBELLE_DEPARTEMENT,LIBELLE_REGION from FR_DISCOVERY.LANDING.A_AGENCE_ONSITE_CONCU_PARTIEL_STEP_2_MARTIN as A 

    left join(select SIRET,LIBELLE_DEPARTEMENT,LIBELLE_REGION from FR_DISCOVERY.LANDING_EXT.SIRET_INSEE) as B 

    on B.SIRET = A.SIRET 

    where A.LONGITUDE IS NOT NULL 

); 

  

select * from FR_DISCOVERY.LANDING.A_AGENCE_ONSITE_CONCU_PARTIEL_STEP_3_MARTIN;
